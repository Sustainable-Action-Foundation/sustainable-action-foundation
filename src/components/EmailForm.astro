---

---

<script>    

    function submitMail(event: Event) {
        event.preventDefault();

        const formData = new FormData(event.currentTarget as HTMLFormElement);

        const data = {
            email: formData.get("email"),
            contents: formData.get("contents"), 
            siteVerifyToken: formData.get("cf-turnstile-response")
        }

        const socket = new WebSocket("ws://localhost:8080");
        socket.addEventListener("open", () => {
            socket.send(JSON.stringify(data));
        });
        
        // TODO: Logged messages should be displayed to the user
        socket.addEventListener("message", (message) => {
            const response = JSON.parse(message.data)

            if (response.context == 'email') {
                if (response.status == false) {
                    console.log('Något gick fel när ditt meddelande skulle skickas. Vänligen uppdatera sidan eller vänta en stund och försök igen.') // TODO: Seperate messages for a failed captcha and failure to send email?
                } else {
                    console.log('Ditt meddelande har skickats!')
                }
            } 
            
            if (response.context == 'turnstile'){
                console.log('Något gick fel när ditt meddelande skulle skickas. Vänligen uppdatera sidan eller vänta en stund och försök igen.')
            }

            socket.close()
        })
    }

    document.getElementById('email-form')?.addEventListener('submit', submitMail)

</script>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<form id="email-form">
    <label class="font-weight-500 block margin-block-100">
        E-postadress
        <input class="margin-block-25" type="email" name="email" id="email" />
    </label>
    <label class="font-weight-500 block margin-block-100">
        Meddelande
        <textarea class="margin-block-25" name="contents" id="contents" style="min-height: 175px; resize: vertical;" />
    </label>
    <button class="font-weight-500 margin-inline-auto block margin-top-200" type="submit" id="submit-email" style="background-color: #337c3b; color: white; width: min(400px, 100%);" >Skicka meddelande</button>
    <div class="margin-top-200 margin-inline-auto" style="height: 65px; width: 300px;">
        <div 
            class="cf-turnstile" 
            data-sitekey="0x4AAAAAABVKHoNTtZQdCs02" 
            data-callback="javascriptCallback" 
            data-theme="light">
        </div>
    </div>
</form>
