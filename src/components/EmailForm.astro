---

---

<script>    

    function submitMail(event: Event) {
        event.preventDefault();

        const status_message_element = document.getElementById('message_status') 
        const submitButtonElement = document.getElementById('submit-email')
        if (!status_message_element || !submitButtonElement) {
            return
        }

        // Set form aria-busy="true" to indicate it is doing stuff 
        const formElement = (event.currentTarget as HTMLFormElement)
        formElement.setAttribute('aria-busy', 'true');

        // Disable submit button while loading
        submitButtonElement.setAttribute('disabled', 'true')

        const formData = new FormData(formElement);

        const data = {
            name: formData.get("name"),
            email: formData.get("email"),
            contents: formData.get("contents"), 
            siteVerifyToken: formData.get("cf-turnstile-response")
        }

        const socket = new WebSocket("ws://localhost:8080");
        socket.addEventListener("open", () => {
            socket.send(JSON.stringify(data));
        });
        
        socket.addEventListener("message", (message) => {
            const response = JSON.parse(message.data)

            if (response.context == 'email') {
                if (response.status == false) {
                    status_message_element.style.color = 'red'
                    status_message_element.innerText = 'Något gick fel när ditt meddelande skulle skickas. Vänligen uppdatera sidan eller vänta en stund och försök igen.'  // TODO: Seperate messages for a failed captcha and failure to send email?
                } else {
                    status_message_element.style.color = 'green'
                    status_message_element.innerText = 'Tack för ditt meddelande!'
                }
            } 
            
            if (response.context == 'turnstile') {
                status_message_element.style.color = 'red'
                status_message_element.innerText = 'Något gick fel när ditt meddelande skulle skickas. Vänligen uppdatera sidan eller vänta en stund och försök igen.'
            }

            // TODO: Appropriate to set aria-busy and disabled to false here?
            formElement.setAttribute('aria-busy', 'false');
            submitButtonElement.removeAttribute('disabled')
            socket.close()
        }) 
    }

    document.getElementById('email-form')?.addEventListener('submit', submitMail)

</script>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

{/* TODO: Clarify names and id's here */}
<form id="email-form">
    <label class="font-weight-500 block margin-block-100">
        Namn
        <input class="margin-block-25" type="text" name="name" id="name" />
    </label>
    <label class="font-weight-500 block margin-block-100">
        E-postadress
        <input class="margin-block-25" type="email" name="email" id="email" />
    </label>
    <label class="font-weight-500 block margin-block-100">
        Meddelande
        <textarea class="margin-block-25" name="contents" id="contents" style="min-height: 175px; resize: vertical;" />
    </label>
    <block class="margin-block-100" style="height: 65px;">
        <div 
            class="cf-turnstile" 
            data-sitekey="0x4AAAAAABVKHoNTtZQdCs02" 
            data-callback="javascriptCallback" 
            data-theme="light"
            data-size="flexible">
        </div>
    </block>
    <flex class="justify-content-space-between align-items-center gap-100 flex-wrap-wrap">
        <button 
            class="position-relative flex align-items-center justify-content-space-between gap-100 padding-inline-100 font-weight-500" 
            type="submit" 
            id="submit-email" 
        >
            Skicka
            <img src="/icons/send.svg" width="20" height="20" alt="" />
        </button>
        <output id="message_status"></output>
    </flex>
</form>

<style> 
    output {
        max-width: 50ch;
    }

    button {
        background-color: #000; 
        color: white; 
        font-size: .85rem; 
        border-radius: .25rem; 
        line-height: 1; 
        min-height: 36px;
        transition: box-shadow .2s ease,
                    background-color .2s ease;
    }

    button:hover {
		background-color: #191919;
		box-shadow: 2px 2px #000;
	}

    button:active {
        transform: scale(.98);
    }

    form[aria-busy="true"] button {
        background-color: #000 !important;
        box-shadow: none !important;
    }

    form[aria-busy="true"] button::after {
        content: url('/icons/ring-resize.svg');
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        transform: translateY(-50%);
        right: 1rem;
        display: grid;
        place-content: center;
        background-color: #000;
    }


</style>